---
title: Tarefas do provedor de armazenamento de mensagens de envio
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: acbfd3ae-bfdc-4103-bed2-6bcf7b9c448c
description: 'Última modificação: 9 de março de 2015'
ms.openlocfilehash: b65113e59b236b1f13596627a8669ae458f76369
ms.sourcegitcommit: 8657170d071f9bcf680aba50b9c07f2a4fb82283
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 04/28/2019
ms.locfileid: "33406497"
---
# <a name="sending-messages-message-store-provider-tasks"></a><span data-ttu-id="af490-103">Enviar mensagens: tarefas do provedor de repositório de mensagens</span><span class="sxs-lookup"><span data-stu-id="af490-103">Sending Messages: Message Store Provider Tasks</span></span>

<span data-ttu-id="af490-104">**Aplica-se a**: Outlook 2013 | Outlook 2016</span><span class="sxs-lookup"><span data-stu-id="af490-104">**Applies to**: Outlook 2013 | Outlook 2016</span></span> 
  
<span data-ttu-id="af490-105">Um provedor de repositório de mensagens é envolvido com o processo de envio de mensagens quando um cliente chama o método [IMessage:: SubmitMessage](imessage-submitmessage.md) da mensagem.</span><span class="sxs-lookup"><span data-stu-id="af490-105">A message store provider gets involved with the message sending process when a client calls the message's [IMessage::SubmitMessage](imessage-submitmessage.md) method.</span></span> <span data-ttu-id="af490-106">Se várias mensagens forem enviadas, o repositório de mensagens deverá enviá-las na mesma ordem em que o cliente usou para suas chamadas do **SubmitMessage** .</span><span class="sxs-lookup"><span data-stu-id="af490-106">If multiple messages are to be sent, the message store must send them in the same order that the client used for its **SubmitMessage** calls.</span></span> 
  
<span data-ttu-id="af490-107">O provedor de repositório de mensagens determina se o spooler MAPI deve ou não ser envolvedo.</span><span class="sxs-lookup"><span data-stu-id="af490-107">The message store provider determines whether or not to involve the MAPI spooler.</span></span> <span data-ttu-id="af490-108">Se o provedor de repositório de mensagens não estiver rigidamente acoplado, a mensagem exigirá o pré-processamento, ou o transporte rigidamente acoplado e o transporte não poderão lidar com todos os destinatários, o spooler MAPI deverá estar envolvido.</span><span class="sxs-lookup"><span data-stu-id="af490-108">If the message store provider is not tightly coupled, the message requires preprocessing, or the tightly coupled store and transport cannot handle all of the recipients, the MAPI spooler must be involved.</span></span> 
  
<span data-ttu-id="af490-109">O procedimento a seguir descreve as tarefas necessárias para um provedor de armazenamento de mensagens para o envio de uma mensagem.</span><span class="sxs-lookup"><span data-stu-id="af490-109">The following procedure describes the tasks required of a message store provider for sending a message.</span></span> 
  
<span data-ttu-id="af490-110">**No IMessage:: SubmitMessage, o provedor do repositório de mensagens**:</span><span class="sxs-lookup"><span data-stu-id="af490-110">**In IMessage::SubmitMessage, the message store provider**:</span></span>
  
1. <span data-ttu-id="af490-111">Chama [IMAPISupport::P reparesubmit](imapisupport-preparesubmit.md) se a mensagem tiver o sinalizador MSGFLAG_RESEND definido em sua propriedade **PR_MESSAGE_FLAGS** ([PidTagMessageFlags](pidtagmessageflags-canonical-property.md)) e retornar qualquer erro para o cliente.</span><span class="sxs-lookup"><span data-stu-id="af490-111">Calls [IMAPISupport::PrepareSubmit](imapisupport-preparesubmit.md) if the message has the MSGFLAG_RESEND flag set in its **PR_MESSAGE_FLAGS** ([PidTagMessageFlags](pidtagmessageflags-canonical-property.md)) property and returns any errors to the client.</span></span> <span data-ttu-id="af490-112">**PrepareSubmit** verifica a propriedade **PR_RECIPIENT_TYPE** ([PidTagRecipientType](pidtagrecipienttype-canonical-property.md)) de cada destinatário na lista de destinatários da mensagem.</span><span class="sxs-lookup"><span data-stu-id="af490-112">**PrepareSubmit** checks the **PR_RECIPIENT_TYPE** ([PidTagRecipientType](pidtagrecipienttype-canonical-property.md)) property of each recipient in the message's recipient list.</span></span>
    
   - <span data-ttu-id="af490-113">Se o sinalizador MAPI_SUBMITTED estiver definido, indicando que o destinatário não recebeu a mensagem original, **PrepareSubmit** limpa o sinalizador e define a propriedade **PR_RESPONSIBILITY** ([PidTagResponsibility](pidtagresponsibility-canonical-property.md)) como true.</span><span class="sxs-lookup"><span data-stu-id="af490-113">If the MAPI_SUBMITTED flag is set, indicating that the recipient did not receive the original message, **PrepareSubmit** clears the flag and sets the **PR_RESPONSIBILITY** ([PidTagResponsibility](pidtagresponsibility-canonical-property.md)) property to TRUE.</span></span> 
    
   - <span data-ttu-id="af490-114">Se o sinalizador MAPI_SUBMITTED não estiver definido, indicando que o destinatário recebeu a mensagem original, **PrepareSubmit** altera a propriedade **PR_RECIPIENT_TYPE** para MAPI_P1 e define a propriedade **PR_RESPONSIBILITY** como true e retorna qualquer erro gerado pelo **PrepareSubmit** para o cliente.</span><span class="sxs-lookup"><span data-stu-id="af490-114">If the MAPI_SUBMITTED flag is not set, indicating that the recipient did receive the original messsage, **PrepareSubmit** changes the **PR_RECIPIENT_TYPE** property to MAPI_P1 and sets the **PR_RESPONSIBILITY** property to TRUE and returns any error generated by **PrepareSubmit** to the client.</span></span> 
    
2. <span data-ttu-id="af490-115">Define o sinalizador MSGFLAG_SUBMIT na propriedade **PR_MESSAGE_FLAGS** da mensagem.</span><span class="sxs-lookup"><span data-stu-id="af490-115">Sets the MSGFLAG_SUBMIT flag in the message's **PR_MESSAGE_FLAGS** property.</span></span> 
    
3. <span data-ttu-id="af490-116">Verifica se há uma coluna para **PR_RESPONSIBILITY** na tabela de destinatários e a define como false para indicar que nenhum transporte tem a responsabilidade assumida por transmitir a mensagem.</span><span class="sxs-lookup"><span data-stu-id="af490-116">Makes sure that there is a column for **PR_RESPONSIBILITY** in the recipient table and sets it to FALSE to indicate that no transport has of yet assumed responsibility for transmitting the message.</span></span> 
    
4. <span data-ttu-id="af490-117">Define a data e a hora da origem na propriedade **PR_CLIENT_SUBMIT_TIME** ([PidTagClientSubmitTime](pidtagclientsubmittime-canonical-property.md)).</span><span class="sxs-lookup"><span data-stu-id="af490-117">Sets the date and time of origination in the **PR_CLIENT_SUBMIT_TIME** ([PidTagClientSubmitTime](pidtagclientsubmittime-canonical-property.md)) property.</span></span>
    
5. <span data-ttu-id="af490-118">Chama [IMAPISupport:: ExpandRecips](imapisupport-expandrecips.md) :</span><span class="sxs-lookup"><span data-stu-id="af490-118">Calls [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md) to:</span></span> 
    
   - <span data-ttu-id="af490-119">Expanda todas as listas de distribuição pessoal e destinatários personalizados e substitua todos os nomes de exibição alterados por seus nomes originais.</span><span class="sxs-lookup"><span data-stu-id="af490-119">Expand all personal distribution lists and custom recipients and replace all changed display names with their original names.</span></span>
   - <span data-ttu-id="af490-120">Remover nomes duplicados.</span><span class="sxs-lookup"><span data-stu-id="af490-120">Remove duplicate names.</span></span>
   - <span data-ttu-id="af490-121">Verifique se há algum pré-processamento necessário e se o pré-processamento é necessário, defina o sinalizador NEEDS_PREPROCESSING e a propriedade **PR_PREPROCESS** ([PidTagPreprocess](pidtagpreprocess-canonical-property.md)), uma propriedade reservada para MAPI.</span><span class="sxs-lookup"><span data-stu-id="af490-121">Check for any required preprocessing, and if preprocessing is required, set the NEEDS_PREPROCESSING flag and the **PR_PREPROCESS** ([PidTagPreprocess](pidtagpreprocess-canonical-property.md)) property, a property reserved for MAPI.</span></span> 
   - <span data-ttu-id="af490-122">Defina o sinalizador NEEDS_SPOOLER se o repositório de mensagens estiver rigidamente acoplado a um transporte e não puder lidar com todos os destinatários.</span><span class="sxs-lookup"><span data-stu-id="af490-122">Set the NEEDS_SPOOLER flag if the message store is tightly coupled with a transport and it cannot handle all of the recipients.</span></span> 
    
6. <span data-ttu-id="af490-123">Executa as seguintes tarefas se o sinalizador de mensagem NEEDS_PREPROCESSING estiver definido:</span><span class="sxs-lookup"><span data-stu-id="af490-123">Performs the following tasks if the NEEDS_PREPROCESSING message flag is set:</span></span>
    
   - <span data-ttu-id="af490-124">Coloca a mensagem na fila de saída com o conjunto de bits SUBMITFLAG_PREPROCESS na propriedade **PR_SUBMIT_FLAGS** ([PidTagSubmitFlags](pidtagsubmitflags-canonical-property.md)).</span><span class="sxs-lookup"><span data-stu-id="af490-124">Puts the message in the outgoing queue with the SUBMITFLAG_PREPROCESS bit set in the **PR_SUBMIT_FLAGS** ([PidTagSubmitFlags](pidtagsubmitflags-canonical-property.md)) property.</span></span>
   - <span data-ttu-id="af490-125">Notifica o spooler MAPI de que a fila foi alterada.</span><span class="sxs-lookup"><span data-stu-id="af490-125">Notifies the MAPI spooler that the queue has changed.</span></span>
   - <span data-ttu-id="af490-126">Retorna o controle ao cliente e o fluxo de mensagens continua no spooler MAPI.</span><span class="sxs-lookup"><span data-stu-id="af490-126">Returns control to the client, and message flow continues in the MAPI spooler.</span></span> 
   - <span data-ttu-id="af490-127">O spooler MAPI realiza as seguintes tarefas:</span><span class="sxs-lookup"><span data-stu-id="af490-127">The MAPI spooler performs the following tasks:</span></span>
     - <span data-ttu-id="af490-128">Bloqueia a mensagem chamando IMsgStore:: setLockstate.</span><span class="sxs-lookup"><span data-stu-id="af490-128">Locks the message by calling IMsgStore::SetLockState.</span></span> 
     - <span data-ttu-id="af490-129">Realiza o pré-processamento necessário chamando todas as funções de pré-processamento na ordem de registro.</span><span class="sxs-lookup"><span data-stu-id="af490-129">Performs the needed preprocessing by calling all of the preprocessing functions in the order of registration.</span></span> <span data-ttu-id="af490-130">Os provedores de transporte chamam IMAPISupport:: RegisterPreprocessor para registrar funções de pré-processamento.</span><span class="sxs-lookup"><span data-stu-id="af490-130">Transport providers call IMAPISupport::RegisterPreprocessor to register preprocessing functions.</span></span> 
     - <span data-ttu-id="af490-131">Chama IMessage:: SubmitMessage na mensagem aberta para indicar ao repositório de mensagens que o pré-processamento está completo.</span><span class="sxs-lookup"><span data-stu-id="af490-131">Calls IMessage::SubmitMessage on the open message to indicate to the message store that preprocessing is complete.</span></span>

<br/>

<span data-ttu-id="af490-132">As duas etapas a seguir ocorrem no processo de cliente, se não houver pré-processamento, e quando o spooler MAPI chamar **SubmitMessage** se houver pré-processamento.</span><span class="sxs-lookup"><span data-stu-id="af490-132">The following two steps occur in the client process if there was no preprocessing, and when the MAPI spooler calls **SubmitMessage** if there was preprocessing.</span></span> 

<span data-ttu-id="af490-133">**O provedor do repositório de mensagens**:</span><span class="sxs-lookup"><span data-stu-id="af490-133">**The message store provider**:</span></span>

1. <span data-ttu-id="af490-134">Realiza as seguintes tarefas se o repositório de mensagens estiver rigidamente acoplado a um transporte e o sinalizador NEEDS_SPOOLER retornado de [IMAPISupport:: ExpandRecips](imapisupport-expandrecips.md):</span><span class="sxs-lookup"><span data-stu-id="af490-134">Performs the following tasks if the message store is tightly coupled to a transport and the NEEDS_SPOOLER flag was returned from [IMAPISupport::ExpandRecips](imapisupport-expandrecips.md):</span></span>
    
   - <span data-ttu-id="af490-135">Cuida de qualquer destinatário que possa lidar.</span><span class="sxs-lookup"><span data-stu-id="af490-135">Handles any recipients that it can handle.</span></span>
   - <span data-ttu-id="af490-136">Define a propriedade **PR_RESPONSIBILITY** como true para todos os destinatários que ele manipula.</span><span class="sxs-lookup"><span data-stu-id="af490-136">Sets the **PR_RESPONSIBILITY** property to TRUE for any recipients that it handles.</span></span> 
   - <span data-ttu-id="af490-137">Realiza as seguintes tarefas se todos os destinatários forem conhecidos por esse transporte e transporte rigidamente acoplados:</span><span class="sxs-lookup"><span data-stu-id="af490-137">Performs the following tasks if all recipients are known to this tightly coupled store and transport:</span></span>
     - <span data-ttu-id="af490-138">Chama IMAPISupport:: CompleteMsg se a mensagem tiver sido preprocessada ou se o provedor de repositório de mensagens quiser que o spooler MAPI conclua o processamento de mensagens, o que é recomendado para que os ganchos de mensagens possam ser chamados.</span><span class="sxs-lookup"><span data-stu-id="af490-138">Calls IMAPISupport::CompleteMsg if the message was preprocessed or the message store provider wants the MAPI spooler to complete message processing which is recommended so that messaging hooks can be invoked.</span></span> <span data-ttu-id="af490-139">O fluxo de mensagens continua com o spooler MAPI, conforme descrito no procedimento a seguir.</span><span class="sxs-lookup"><span data-stu-id="af490-139">Message flow continues with the MAPI spooler as described in the following procedure.</span></span>  
     - <span data-ttu-id="af490-140">Realiza as seguintes tarefas se a mensagem não tiver sido preprocessada ou se o provedor do repositório de mensagens não quiser que o spooler MAPI Complete o processamento de mensagens:</span><span class="sxs-lookup"><span data-stu-id="af490-140">Performs the following tasks if the message was not preprocessed or the message store provider does not want the MAPI spooler to complete message processing:</span></span>
       - <span data-ttu-id="af490-141">Copia a mensagem para a pasta identificada pelo identificador de entrada na propriedade PR_SENTMAIL_ENTRYID (PidTagSentMailEntryId), se definida.</span><span class="sxs-lookup"><span data-stu-id="af490-141">Copies the message to the folder identified by the entry identifier in the PR_SENTMAIL_ENTRYID (PidTagSentMailEntryId) property, if set.</span></span>
       - <span data-ttu-id="af490-142">Exclui a mensagem se a propriedade PR_DELETE_AFTER_SUBMIT (PidTagDeleteAfterSubmit) tiver sido definida como TRUE.</span><span class="sxs-lookup"><span data-stu-id="af490-142">Deletes the message if the PR_DELETE_AFTER_SUBMIT (PidTagDeleteAfterSubmit) property has been set to TRUE.</span></span>
       - <span data-ttu-id="af490-143">Desbloqueia a mensagem se estiver bloqueada.</span><span class="sxs-lookup"><span data-stu-id="af490-143">Unlocks the message if it is locked.</span></span>
       - <span data-ttu-id="af490-144">Retorna ao cliente.</span><span class="sxs-lookup"><span data-stu-id="af490-144">Returns to the client.</span></span> <span data-ttu-id="af490-145">O fluxo de mensagens foi concluído.</span><span class="sxs-lookup"><span data-stu-id="af490-145">Message flow is complete.</span></span> 
   
2. <span data-ttu-id="af490-146">Realiza as seguintes tarefas se o repositório de mensagens não estiver rigidamente acoplado a um transporte, nem todos os destinatários foram conhecidos no repositório de mensagens ou se o sinalizador NEEDS_SPOOLER estiver definido:</span><span class="sxs-lookup"><span data-stu-id="af490-146">Performs the following tasks if the message store is not tightly coupled to a transport, not all of the recipients were known to the message store, or the NEEDS_SPOOLER flag is set:</span></span>
    
   - <span data-ttu-id="af490-147">Coloca a mensagem na fila de saída sem definir o bit SUBMITFLAG_PREPROCESS na propriedade **PR_SUBMIT_FLAGS** .</span><span class="sxs-lookup"><span data-stu-id="af490-147">Puts the message in the outgoing queue without setting the SUBMITFLAG_PREPROCESS bit in the **PR_SUBMIT_FLAGS** property.</span></span> 
   - <span data-ttu-id="af490-148">Notifica o spooler MAPI de que a fila de saída foi alterada gerando uma notificação de tabela.</span><span class="sxs-lookup"><span data-stu-id="af490-148">Notifies the MAPI spooler that the outgoing queue has changed by generating a table notification.</span></span> 
   - <span data-ttu-id="af490-149">Retorna ao cliente e o fluxo de mensagens continua com um conjunto de tarefas executadas pelo spooler MAPI.</span><span class="sxs-lookup"><span data-stu-id="af490-149">Returns to the client, and message flow continues with a set of tasks performed by the MAPI spooler.</span></span>
    
<span data-ttu-id="af490-150">Quando uma mensagem é manipulada pelo spooler MAPI, o provedor do repositório de mensagens define a propriedade **PR_SUBMIT_FLAGS** da mensagem como SUBMITFLAG_LOCKED.</span><span class="sxs-lookup"><span data-stu-id="af490-150">When a message is to be handled by the MAPI spooler, the message store provider sets the message's **PR_SUBMIT_FLAGS** property to SUBMITFLAG_LOCKED.</span></span> <span data-ttu-id="af490-151">O sinalizador SUBMITFLAG_LOCKED indica que o spooler MAPI bloqueou a mensagem para seu uso exclusivo.</span><span class="sxs-lookup"><span data-stu-id="af490-151">The SUBMITFLAG_LOCKED flag indicates that the MAPI spooler has locked the message for its exclusive use.</span></span> <span data-ttu-id="af490-152">O outro valor para **PR_SUBMIT_FLAGS,** SUBMITFLAG_PREPROCESS, é definido quando a mensagem requer o pré-processamento por uma ou mais funções de pré-processador registradas por um provedor de transporte.</span><span class="sxs-lookup"><span data-stu-id="af490-152">The other value for **PR_SUBMIT_FLAGS,** SUBMITFLAG_PREPROCESS, is set when the message requires preprocessing by one or more preprocessor functions registered by a transport provider.</span></span> 
  

