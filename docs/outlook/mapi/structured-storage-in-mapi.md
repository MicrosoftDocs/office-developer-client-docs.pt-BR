---
title: Armazenamento estruturado no MAPI
manager: soliver
ms.date: 03/09/2015
ms.audience: Developer
localization_priority: Normal
api_type:
- COM
ms.assetid: 642a678b-4bf2-4246-85cb-c798de23e36f
description: 'Última modificação: 9 de março de 2015'
ms.openlocfilehash: 462ee84d5e9acd26f80bae6516179f21651749be
ms.sourcegitcommit: 9d60cd82b5413446e5bc8ace2cd689f683fb41a7
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 06/11/2018
ms.locfileid: "19770533"
---
# <a name="structured-storage-in-mapi"></a><span data-ttu-id="b8e55-103">Armazenamento estruturado no MAPI</span><span class="sxs-lookup"><span data-stu-id="b8e55-103">Structured Storage in MAPI</span></span>

  
  
<span data-ttu-id="b8e55-104">**Aplica-se a**: Outlook</span><span class="sxs-lookup"><span data-stu-id="b8e55-104">**Applies to**: Outlook</span></span> 
  
<span data-ttu-id="b8e55-105">Armazenamento estruturado refere-se para a organização hierárquica de armazenamento introduzido com COM.</span><span class="sxs-lookup"><span data-stu-id="b8e55-105">Structured storage refers to the hierarchical organization of storage introduced with COM.</span></span> <span data-ttu-id="b8e55-106">Em um ambiente de armazenamento estruturado, o armazenamento é organizado em dois ou três tipos de objetos:</span><span class="sxs-lookup"><span data-stu-id="b8e55-106">In a structured storage environment, storage is organized into two or three types of objects:</span></span> 
  
- <span data-ttu-id="b8e55-107">Objetos Stream</span><span class="sxs-lookup"><span data-stu-id="b8e55-107">Stream objects</span></span>
    
- <span data-ttu-id="b8e55-108">Objetos de bytes de bloqueio</span><span class="sxs-lookup"><span data-stu-id="b8e55-108">Lock bytes objects</span></span>
    
- <span data-ttu-id="b8e55-109">Objetos de armazenamento</span><span class="sxs-lookup"><span data-stu-id="b8e55-109">Storage objects</span></span>
    
<span data-ttu-id="b8e55-110">Stream e bloqueio bytes são objetos de nível inferior que acessem diretamente os dados.</span><span class="sxs-lookup"><span data-stu-id="b8e55-110">Stream and lock bytes are lower-level objects that directly access the data.</span></span> <span data-ttu-id="b8e55-111">Objetos Stream implementam a interface **IStream** que define métodos para ler, gravar, posicionamento e cópia bytes de dados.</span><span class="sxs-lookup"><span data-stu-id="b8e55-111">Stream objects implement the **IStream** interface which defines methods for reading, writing, positioning, and copying bytes of data.</span></span> <span data-ttu-id="b8e55-112">Objetos de bytes de bloqueio implementar outra interface COM, **ILockBytes**, para acessar dados com uma matriz de bytes.</span><span class="sxs-lookup"><span data-stu-id="b8e55-112">Lock bytes objects implement another COM interface, **ILockBytes**, to access data with a byte array.</span></span> <span data-ttu-id="b8e55-113">Matrizes de byte geralmente são usados para fornecer um acesso personalizado para o armazenamento subjacente.</span><span class="sxs-lookup"><span data-stu-id="b8e55-113">Byte arrays are typically used to provide customized access to underlying storage.</span></span>
  
<span data-ttu-id="b8e55-114">Objetos de armazenamento são colocados sobre os objetos de bytes do fluxo ou bloqueio; eles podem conter uma ou mais desses objetos, bem como outros objetos de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="b8e55-114">Storage objects are layered on top of the stream or lock bytes objects; they can contain one or more of these objects as well as other storage objects.</span></span> <span data-ttu-id="b8e55-115">Objetos de armazenamento implementam a interface de **IStorage** que define métodos para criar, acessando e manter os objetos aninhados.</span><span class="sxs-lookup"><span data-stu-id="b8e55-115">Storage objects implement the **IStorage** interface which defines methods for creating, accessing, and maintaining nested objects.</span></span> 
  
<span data-ttu-id="b8e55-116">Como **IStream**, **ILockBytes**e **IStorage** são interfaces COM, em vez de interfaces MAPI, seus métodos retornam valores de erro COM em vez de valores MAPI.</span><span class="sxs-lookup"><span data-stu-id="b8e55-116">Because **IStream**, **ILockBytes**, and **IStorage** are COM interfaces rather than MAPI interfaces, their methods return COM error values rather than MAPI values.</span></span> <span data-ttu-id="b8e55-117">Clientes e chamar métodos nessas interfaces de provedores de serviços devem usar a função de API **MapStorageSCode** traduzir esses valores para os valores de erro MAPI.</span><span class="sxs-lookup"><span data-stu-id="b8e55-117">Clients and service providers calling methods in these interfaces must use the API function **MapStorageSCode** to translate these values into MAPI error values.</span></span> <span data-ttu-id="b8e55-118">Para obter mais informações, consulte [MapStorageSCode](mapstoragescode.md).</span><span class="sxs-lookup"><span data-stu-id="b8e55-118">For more information, see [MapStorageSCode](mapstoragescode.md).</span></span>
  
<span data-ttu-id="b8e55-119">Clientes e provedores de serviço usam armazenamento estruturado para trabalhar com propriedades que são grandes demais para manter-se com os métodos, normalmente grande cadeia de caracteres e propriedades binárias **IMAPIProp** .</span><span class="sxs-lookup"><span data-stu-id="b8e55-119">Clients and service providers use structured storage for working with properties that are too large to maintain with the **IMAPIProp** methods, typically large string and binary properties.</span></span> <span data-ttu-id="b8e55-120">Uma das maneiras comuns que os clientes ou provedores de serviços acessá-las é especificando **IStream** ou **IStorage** como o identificador de interface em uma chamada ao método [IMAPIProp::OpenProperty](imapiprop-openproperty.md) .</span><span class="sxs-lookup"><span data-stu-id="b8e55-120">One of the common ways that clients or service providers access them is by specifying **IStream** or **IStorage** as the interface identifier in a call to the [IMAPIProp::OpenProperty](imapiprop-openproperty.md) method.</span></span> <span data-ttu-id="b8e55-121">Por exemplo, os clientes chamar **OpenProperty** com **PR_ATTACH_DATA_BIN** como a marca de propriedade e IID_IStream como o identificador de interface para acessar um anexo binário em uma mensagem.</span><span class="sxs-lookup"><span data-stu-id="b8e55-121">For example, clients call **OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag and IID_IStream as the interface identifier to access a binary attachment in a message.</span></span> 
  
<span data-ttu-id="b8e55-122">Clientes e provedores de serviço podem implementar seus próprios objetos stream e armazenamento ou chamar funções da API para implementações de acesso fornecidas pelo MAPI ou COM.</span><span class="sxs-lookup"><span data-stu-id="b8e55-122">Clients and service providers can implement their own stream and storage objects or call API functions to access implementations supplied by MAPI or COM.</span></span> <span data-ttu-id="b8e55-123">Como as implementações fornecidas atendem a maioria das finalidades, clientes e provedores de serviços raramente precisam criar suas próprias.</span><span class="sxs-lookup"><span data-stu-id="b8e55-123">Because the supplied implementations serve most purposes, clients and service providers rarely need to create their own.</span></span> 
  
<span data-ttu-id="b8e55-124">Quando um cliente chamadas **OpenProperty** em um objeto MAPI para acessar uma de suas propriedades por meio de um objeto de armazenamento, o provedor de serviço geralmente abrirá o objeto de armazenamento no modo direto.</span><span class="sxs-lookup"><span data-stu-id="b8e55-124">When a client calls **OpenProperty** on a MAPI object to access one of its properties through a storage object, the service provider will typically open the storage object in direct mode.</span></span> <span data-ttu-id="b8e55-125">No entanto, isso é normal em vez de comportamento necessário.</span><span class="sxs-lookup"><span data-stu-id="b8e55-125">However, this is typical rather than required behavior.</span></span> <span data-ttu-id="b8e55-126">Os clientes devem pressupõem que todos os objetos de armazenamento abertos ou criados por provedores de serviços serão transacionados e exigem uma chamada para **IStorage::Commit**.</span><span class="sxs-lookup"><span data-stu-id="b8e55-126">Clients should assume that all storage objects opened or created by service providers are transacted and require a call to **IStorage::Commit**.</span></span> <span data-ttu-id="b8e55-127">Eles também devem se lembrar que as alterações em objetos de armazenamento não serão feitas permanentes até ligarem **IMAPIProp::SaveChanges** após o final **Confirmar** para salvar o objeto MAPI.</span><span class="sxs-lookup"><span data-stu-id="b8e55-127">They should also remember that changes to storage objects will not be made permanent until they call **IMAPIProp::SaveChanges** after the final **Commit** to save the MAPI object.</span></span> <span data-ttu-id="b8e55-128">Para obter mais informações, consulte [IMAPIProp::SaveChanges](imapiprop-savechanges.md).</span><span class="sxs-lookup"><span data-stu-id="b8e55-128">For more information, see [IMAPIProp::SaveChanges](imapiprop-savechanges.md).</span></span>
  
<span data-ttu-id="b8e55-129">MAPI e COM fornecem várias funções de API para definir ou acessando objetos stream e armazenamento.</span><span class="sxs-lookup"><span data-stu-id="b8e55-129">MAPI and COM provide several API functions for defining or accessing storage and stream objects.</span></span> <span data-ttu-id="b8e55-130">As funções comumente usadas são descritas na tabela a seguir.</span><span class="sxs-lookup"><span data-stu-id="b8e55-130">The commonly used functions are described in the following table.</span></span>
  
<span data-ttu-id="b8e55-131">**Funções para acessar os objetos Stream e armazenamento**</span><span class="sxs-lookup"><span data-stu-id="b8e55-131">**Functions for Accessing Storage and Stream Objects**</span></span>

|<span data-ttu-id="b8e55-132">**Função**</span><span class="sxs-lookup"><span data-stu-id="b8e55-132">**Function**</span></span>|<span data-ttu-id="b8e55-133">**Descrição**</span><span class="sxs-lookup"><span data-stu-id="b8e55-133">**Description**</span></span>|
|:-----|:-----|
|[<span data-ttu-id="b8e55-134">HrIStorageFromStream</span><span class="sxs-lookup"><span data-stu-id="b8e55-134">HrIStorageFromStream</span></span>](hristoragefromstream.md) <br/> |<span data-ttu-id="b8e55-135">Cria um objeto de armazenamento para acessar um objeto de bytes do fluxo ou bloquear.</span><span class="sxs-lookup"><span data-stu-id="b8e55-135">Creates a storage object to access a stream or lock bytes object.</span></span>  <br/> |
|[<span data-ttu-id="b8e55-136">OpenIMsgOnIStg</span><span class="sxs-lookup"><span data-stu-id="b8e55-136">OpenIMsgOnIStg</span></span>](openimsgonistg.md) <br/> |<span data-ttu-id="b8e55-137">Cria um objeto de mensagem para acessar um objeto de armazenamento.</span><span class="sxs-lookup"><span data-stu-id="b8e55-137">Creates a message object to access a storage object.</span></span>  <br/> |
|[<span data-ttu-id="b8e55-138">OpenStreamOnFile</span><span class="sxs-lookup"><span data-stu-id="b8e55-138">OpenStreamOnFile</span></span>](openstreamonfile.md) <br/> |<span data-ttu-id="b8e55-139">Cria um objeto stream para acessar um arquivo.</span><span class="sxs-lookup"><span data-stu-id="b8e55-139">Creates a stream object to access a file.</span></span>  <br/> |
|[<span data-ttu-id="b8e55-140">WrapCompressedRTFStream</span><span class="sxs-lookup"><span data-stu-id="b8e55-140">WrapCompressedRTFStream</span></span>](wrapcompressedrtfstream.md) <br/> |<span data-ttu-id="b8e55-141">Cria um objeto stream que contém a versão compactada ou descompactada de um stream mantendo o rich text de uma mensagem.</span><span class="sxs-lookup"><span data-stu-id="b8e55-141">Creates a stream object that contains the compressed or uncompressed version of a stream holding the rich text of a message.</span></span>  <br/> |
   
 <span data-ttu-id="b8e55-142">**Para recuperar os nomes dos fluxos em um determinado subarmazenamento**</span><span class="sxs-lookup"><span data-stu-id="b8e55-142">**To retrieve the names of the streams in a given substorage**</span></span>
  
1. <span data-ttu-id="b8e55-143">Chame o método de **IStorage::EnumElements** do subarmazenamento para obter uma interface **IEnumSTATSTG** .</span><span class="sxs-lookup"><span data-stu-id="b8e55-143">Call the substorage's **IStorage::EnumElements** method to get an **IEnumSTATSTG** interface.</span></span> 
    
2. <span data-ttu-id="b8e55-144">Chame **IEnumSTATSTG::Next** com quantos estruturas **STATSTG** por vez possível.</span><span class="sxs-lookup"><span data-stu-id="b8e55-144">Call **IEnumSTATSTG::Next** with as many **STATSTG** structures at a time as you can.</span></span> <span data-ttu-id="b8e55-145">Se você solicitar 100 por vez, **próximo** geralmente retornará S_FALSE com o conteúdo do _pceltFetched_ definido para o número que realmente foram recuperados.</span><span class="sxs-lookup"><span data-stu-id="b8e55-145">If you ask for 100 at a time, **Next** will usually return S_FALSE with the contents of  _pceltFetched_ set to the number that were actually retrieved.</span></span> 
    
3. <span data-ttu-id="b8e55-146">Verificar as estruturas **STATSTG** sinalizados com STGTY_STREAM.</span><span class="sxs-lookup"><span data-stu-id="b8e55-146">Check for the **STATSTG** structures that are flagged with STGTY_STREAM.</span></span> 
    
4. <span data-ttu-id="b8e55-147">Libere o parâmetro _pwcsName_ .</span><span class="sxs-lookup"><span data-stu-id="b8e55-147">Release the  _pwcsName_ parameter.</span></span> 
    
 <span data-ttu-id="b8e55-148">**Para criar um objeto de armazenamento para acessar um objeto de bytes do fluxo ou bloqueio existente**</span><span class="sxs-lookup"><span data-stu-id="b8e55-148">**To create a storage object to access an existing stream or lock bytes object**</span></span>
  
- <span data-ttu-id="b8e55-149">Clientes chamar [HrIStorageFromStream](hristoragefromstream.md).</span><span class="sxs-lookup"><span data-stu-id="b8e55-149">Clients call [HrIStorageFromStream](hristoragefromstream.md).</span></span> 
    
 <span data-ttu-id="b8e55-150">**Para criar um objeto de mensagem para acessar um objeto de armazenamento existente**</span><span class="sxs-lookup"><span data-stu-id="b8e55-150">**To create a message object to access an existing storage object**</span></span>
  
- <span data-ttu-id="b8e55-151">Clientes e provedores de serviços de chamada [OpenIMsgOnIStg](openimsgonistg.md).</span><span class="sxs-lookup"><span data-stu-id="b8e55-151">Service providers and clients call [OpenIMsgOnIStg](openimsgonistg.md).</span></span> <span data-ttu-id="b8e55-152">O objeto de mensagem que é criado difere dos objetos de mensagem geralmente criados por provedores de armazenamento de mensagens em que ele não oferece suporte a todos os [IMessage: IMAPIProp](imessageimapiprop.md) métodos, como **IMessage::SubmitMessage**de interface.</span><span class="sxs-lookup"><span data-stu-id="b8e55-152">The message object that is created differs from the message objects typically created by message store providers in that it does not support all of the [IMessage : IMAPIProp](imessageimapiprop.md) interface methods, such as **IMessage::SubmitMessage**.</span></span> <span data-ttu-id="b8e55-153">Um parâmetro de entrada opcional para **OpenIMsgOnIStg** é uma função de retorno de chamada que está em conformidade com o protótipo [MSGCALLRELEASE](msgcallrelease.md) .</span><span class="sxs-lookup"><span data-stu-id="b8e55-153">An optional input parameter to **OpenIMsgOnIStg** is a callback function that conforms to the [MSGCALLRELEASE](msgcallrelease.md) prototype.</span></span> <span data-ttu-id="b8e55-154">Essa função é chamada pelo novo objeto de mensagem quando chega a contagem de referência da mensagem zero.</span><span class="sxs-lookup"><span data-stu-id="b8e55-154">This function is called by the new message object when the message's reference count reaches zero.</span></span> <span data-ttu-id="b8e55-155">Implementar uma função **MSGCALLRELEASE** pode ser útil para a realização de processamento de final antes da nova mensagem será completamente removida.</span><span class="sxs-lookup"><span data-stu-id="b8e55-155">Implementing a **MSGCALLRELEASE** function can be useful for performing final processing before the new message is completely removed.</span></span> 
    
<span data-ttu-id="b8e55-156">[OpenStreamOnFile](openstreamonfile.md) comumente é usado para armazenar os anexos de arquivo porque ele cria um fluxo que lê da e grava um arquivo.</span><span class="sxs-lookup"><span data-stu-id="b8e55-156">[OpenStreamOnFile](openstreamonfile.md) is commonly used for storing file attachments because it creates a stream that reads from and writes to a file.</span></span> <span data-ttu-id="b8e55-157">**OpenProperty** com **PR_ATTACH_DATA_BIN** como a marca de propriedade cria um fluxo para armazenar dados de anexo binário.</span><span class="sxs-lookup"><span data-stu-id="b8e55-157">**OpenProperty** with **PR_ATTACH_DATA_BIN** as the property tag creates a stream for storing binary attachment data.</span></span> 
  
 <span data-ttu-id="b8e55-158">**Para compactar ou descompactar um stream que contém o texto da mensagem no formato Rich Text**</span><span class="sxs-lookup"><span data-stu-id="b8e55-158">**To compress or uncompress a stream containing message text in the Rich Text Format**</span></span>
  
- <span data-ttu-id="b8e55-159">Clientes chamar [WrapCompressedRTFStream](wrapcompressedrtfstream.md).</span><span class="sxs-lookup"><span data-stu-id="b8e55-159">Clients call [WrapCompressedRTFStream](wrapcompressedrtfstream.md).</span></span> <span data-ttu-id="b8e55-160">**WrapCompressedRTFStream** cria um fluxo que envolve o fluxo RTF.</span><span class="sxs-lookup"><span data-stu-id="b8e55-160">**WrapCompressedRTFStream** creates a stream that wraps the RTF stream.</span></span> <span data-ttu-id="b8e55-161">O fluxo de wrapper não implementa todos os métodos **IStream** ; os métodos a seguir são excluídos: **Seek**, **SetSize**, **Reverter**, **LockRegion**, **UnlockRegion**, **Stat**e **Clone**.</span><span class="sxs-lookup"><span data-stu-id="b8e55-161">The wrapper stream does not implement all of the **IStream** methods; the following methods are excluded: **Seek**, **SetSize**, **Revert**, **LockRegion**, **UnlockRegion**, **Stat**, and **Clone**.</span></span> <span data-ttu-id="b8e55-162">Isso ocorre porque os objetos stream criados pelo **WrapCompressedRTFStream** não suportam **SetSize** ou **Stat**, não há uma maneira fácil de estenda ou recuperar seu tamanho.</span><span class="sxs-lookup"><span data-stu-id="b8e55-162">This is because the stream objects created by **WrapCompressedRTFStream** do not support either **SetSize** or **Stat**, there is not an easy way to either extend or retrieve their size.</span></span> <span data-ttu-id="b8e55-163">A melhor estratégia é selecionar um tamanho de buffer razoável e ler ou gravar em um loop.</span><span class="sxs-lookup"><span data-stu-id="b8e55-163">The best strategy is to pick a reasonable buffer size and read or write in a loop.</span></span>
    
> [!NOTE]
> <span data-ttu-id="b8e55-164">COM tem uma implementação do objeto de armazenamento com base em uma matriz de bytes que retorna um objeto **IEnumSTATSTG** pelo método **EnumElements** problemática.</span><span class="sxs-lookup"><span data-stu-id="b8e55-164">COM has a storage object implementation based on a byte array that returns an **IEnumSTATSTG** object from the **EnumElements** method that is problematic.</span></span> <span data-ttu-id="b8e55-165">Em particular, o método **QueryInterface** não funciona corretamente.</span><span class="sxs-lookup"><span data-stu-id="b8e55-165">In particular, the **QueryInterface** method does not work correctly.</span></span> <span data-ttu-id="b8e55-166">Provedores de serviços que implementam seus próprios objetos de armazenamento usando a implementação COM deverá criar um wrapper fino para o objeto **IEnumSTATSTG** que encaminha as chamadas para os métodos subjacentes de **IEnumSTATSTG** mas implementa seu próprio **AddRef **, Os métodos de **lançamento**, **QueryInterface**e **Clone** .</span><span class="sxs-lookup"><span data-stu-id="b8e55-166">Service providers that implement their own storage objects using the COM implementation should create a thin wrapper for the **IEnumSTATSTG** object that forwards calls on to the underlying **IEnumSTATSTG** methods but implements its own **AddRef**, **Release**, **QueryInterface**, and **Clone** methods.</span></span> 
  

